name: Auto Proxy System

on:
  schedule:
    # Ù‡Ø± Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‡Ù… Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†Ø¯ Ù‡Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ø¯
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  auto-proxy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    
    steps:
      # Ù…Ø±Ø­Ù„Ù‡ Û±: Ù„Ø§Ú¯ Ø²Ù…Ø§Ù†
      - name: â° Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹
        run: |
          echo "ğŸš€ Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ¯Ú©Ø§Ø±"
          echo "ğŸ• UTC: $(date -u)"
          echo "ğŸ‡®ğŸ‡· Ø§ÛŒØ±Ø§Ù†: $(TZ=Asia/Tehran date)"
          
      # Ù…Ø±Ø­Ù„Ù‡ Û²: Ø¯Ø±ÛŒØ§ÙØª Ø±ÛŒÙ¾Ùˆ
      - name: ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # Ù…Ø±Ø­Ù„Ù‡ Û³: Ù†ØµØ¨ Ù¾Ø§ÛŒØªÙˆÙ†
      - name: ğŸ Ù†ØµØ¨ Ù¾Ø§ÛŒØªÙˆÙ†
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          
      # Ù…Ø±Ø­Ù„Ù‡ Û´: Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§
      - name: ğŸ“¦ Ù†ØµØ¨ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
        run: pip install requests jdatetime
        
      # Ù…Ø±Ø­Ù„Ù‡ Ûµ: Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÙ‡Ø§
      - name: ğŸ”„ Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÙ‡Ø§
        run: |
          echo "ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÙ‡Ø§..."
          python update_proxies.py
          
      # Ù…Ø±Ø­Ù„Ù‡ Û¶: Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
      - name: ğŸ“Š Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
        run: |
          echo "ğŸ“ ÙˆØ¶Ø¹ÛŒØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§:"
          echo "texts.txt: $(wc -l < texts.txt) Ø®Ø·"
          echo "last_line.txt: $(cat last_line.txt) Ù…ÙˆÙ‚Ø¹ÛŒØª"
          
      # Ù…Ø±Ø­Ù„Ù‡ Û·: Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…
      - name: ğŸ¤– Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        run: |
          echo "ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…..."
          python bot.py
          
      # Ù…Ø±Ø­Ù„Ù‡ Û¸: Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
      - name: ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡
          git add texts.txt last_line.txt
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†ÛŒØ³Øª"
          else
            git commit -m "ğŸ¤– Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± - $(TZ=Asia/Tehran date '+%H:%M')"
            git push
            echo "âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯"
          fi
          
      # Ù…Ø±Ø­Ù„Ù‡ Û¹: Ù¾Ø§ÛŒØ§Ù†
      - name: ğŸ Ù¾Ø§ÛŒØ§Ù†
        run: |
          echo "âœ… Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ú©Ø§Ù…Ù„ Ø´Ø¯"
          echo "ğŸ• Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†: $(TZ=Asia/Tehran date)"
