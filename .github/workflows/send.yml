name: "ğŸ“¢ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³Øª ØªÙ„Ú¯Ø±Ø§Ù… (Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø±)"

on:
  # Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ù‡Ø± Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡
  schedule:
    - cron: "*/30 * * * *"
  
  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø² GitHub UI
  workflow_dispatch:
    inputs:
      reason:
        description: "Ø¯Ù„ÛŒÙ„ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ"
        required: false
        default: "ØªØ³Øª Ø¯Ø³ØªÛŒ"

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ÛŒØ· Ø§Ø¬Ø±Ø§
env:
  PYTHON_VERSION: "3.10"
  TZ: "Asia/Tehran"
  # Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
  TELEGRAM_DEBUG: "true"
  PYTHONUNBUFFERED: "1"

jobs:
  send-telegram-post:
    name: "Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…"
    runs-on: ubuntu-latest
    
    # Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
    continue-on-error: false
    timeout-minutes: 15  # Ø§ÙØ²Ø§ÛŒØ´ ÛŒØ§ÙØª
    
    steps:
      # Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯
      - name: "ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ø±ÛŒÙ¾ÙˆØ²ÛŒØªÙˆØ±ÛŒ"
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true
      
      # Ù…Ø±Ø­Ù„Ù‡ Û²: ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§ÛŒØªÙˆÙ†
      - name: "ğŸ ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§ÛŒØªÙˆÙ† ${{ env.PYTHON_VERSION }}"
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '**/*requirements*.txt'
      
      # Ù…Ø±Ø­Ù„Ù‡ Û³: Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
      - name: "ğŸ“¦ Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²"
        id: install-deps
        run: |
          echo "ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§..."
          pip install --upgrade pip
          pip install requests==2.31.0
          pip install jdatetime==4.1.1
          echo "âœ… Ù†ØµØ¨ Ú©Ø§Ù…Ù„ Ø´Ø¯"
      
      # Ù…Ø±Ø­Ù„Ù‡ Û´: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
      - name: "ğŸ“Š Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…"
        id: system-check
        run: |
          echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ..."
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ texts.txt
          if [ -f "texts.txt" ]; then
            LINE_COUNT=$(wc -l < texts.txt || echo "0")
            NON_EMPTY_COUNT=$(grep -c '[^[:space:]]' texts.txt || echo "0")
            echo "ğŸ“„ texts.txt: $LINE_COUNT Ø®Ø· (ØºÛŒØ±Ø®Ø§Ù„ÛŒ: $NON_EMPTY_COUNT)"
          else
            echo "âŒ ÙØ§ÛŒÙ„ texts.txt ÛŒØ§ÙØª Ù†Ø´Ø¯!"
            exit 1
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ/Ø§ÛŒØ¬Ø§Ø¯ last_line.txt
          if [ ! -f "last_line.txt" ]; then
            echo "0" > last_line.txt
            echo "ğŸ“ last_line.txt Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ (Ù…Ù‚Ø¯Ø§Ø±: 0)"
          else
            CURRENT_LINE=$(cat last_line.txt 2>/dev/null | tr -d '\n' || echo "0")
            echo "ğŸ“ last_line.txt Ù…ÙˆØ¬ÙˆØ¯ (Ù…Ù‚Ø¯Ø§Ø±: $CURRENT_LINE)"
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ bot.py
          if [ ! -f "bot.py" ]; then
            echo "âŒ ÙØ§ÛŒÙ„ bot.py ÛŒØ§ÙØª Ù†Ø´Ø¯!"
            exit 1
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ø³Ú©Ø±Øªâ€ŒÙ‡Ø§ (ÙÙ‚Ø· Ù‡Ø´Ø¯Ø§Ø±)
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: TELEGRAM_BOT_TOKEN ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡"
          else
            echo "âœ… TELEGRAM_BOT_TOKEN ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡"
          fi
          
          if [ -z "${{ secrets.TELEGRAM_CHANNEL_ID }}" ]; then
            echo "âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: TELEGRAM_CHANNEL_ID ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡"
          else
            echo "âœ… TELEGRAM_CHANNEL_ID ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡"
          fi
          
          echo "âœ… Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯"
      
      # Ù…Ø±Ø­Ù„Ù‡ Ûµ: Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ø§ØµÙ„ÛŒ
      - name: "ğŸ¤– Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…"
        id: run-bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          TELEGRAM_DEBUG: ${{ env.TELEGRAM_DEBUG }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          RUN_REASON: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.reason || 'Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©' }}
        run: |
          echo "ğŸš€ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…"
          echo "ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¬Ø±Ø§:"
          echo "   â€¢ Run ID: $GITHUB_RUN_ID"
          echo "   â€¢ Ø¯Ù„ÛŒÙ„ Ø§Ø¬Ø±Ø§: $RUN_REASON"
          echo "   â€¢ Ø²Ù…Ø§Ù† Ø³Ø±ÙˆØ±: $(date)"
          echo "   â€¢ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ: $TZ"
          echo "   â€¢ Python Version: $(python --version)"
          echo ""
          
          # Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø§ÛŒØªÙˆÙ†
          START_TIME=$(date +%s)
          python bot.py
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "â±ï¸ Ù…Ø¯Øª Ø§Ø¬Ø±Ø§: $DURATION Ø«Ø§Ù†ÛŒÙ‡"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Ø±Ø¨Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯"
          else
            echo "âŒ Ø±Ø¨Ø§Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯ (Ú©Ø¯ Ø®Ø±ÙˆØ¬: $EXIT_CODE)"
            exit $EXIT_CODE
          fi
      
      # Ù…Ø±Ø­Ù„Ù‡ Û¶: Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
      - name: "ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØºÛŒÛŒØ±Ø§Øª"
        id: commit-changes
        if: always()
        run: |
          echo "ğŸ’¾ Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ..."
          
          # ØªÙ†Ø¸ÛŒÙ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡
          git add last_line.txt 2>/dev/null || true
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒØ§ ØªØºÛŒÛŒØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
          if ! git diff --cached --quiet; then
            # Ø§ÛŒØ¬Ø§Ø¯ commit
            COMMIT_MSG="ğŸ¤– Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± last_line.txt"
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              COMMIT_MSG="$COMMIT_MSG (Ø¯Ø³ØªÛŒ)"
            fi
            
            git commit -m "$COMMIT_MSG" -m "Run: ${{ github.run_id }}"
            
            # push ØªØºÛŒÛŒØ±Ø§Øª
            echo "ğŸ“¤ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª..."
            git pull --rebase origin ${{ github.ref_name }}
            git push origin HEAD:${{ github.ref_name }}
            
            echo "âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯"
            echo "CHANGES=true" >> $GITHUB_OUTPUT
            echo "COMMIT_HASH=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“­ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ commit ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
            echo "CHANGES=false" >> $GITHUB_OUTPUT
          fi
      
      # Ù…Ø±Ø­Ù„Ù‡ Û·: Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
      - name: "ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø¬Ø±Ø§"
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø¬Ø±Ø§"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ ÙˆØ¶Ø¹ÛŒØª: ${{ job.status }}"
          echo "ğŸ†” Ø´Ù†Ø§Ø³Ù‡ Ø§Ø¬Ø±Ø§: ${{ github.run_id }}"
          echo "ğŸ”¢ Ø´Ù…Ø§Ø±Ù‡ Ø§Ø¬Ø±Ø§: ${{ github.run_number }}"
          echo "ğŸ”§ Ø¯Ù„ÛŒÙ„ Ø§Ø¬Ø±Ø§: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.reason || 'Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©' }}"
          
          # Ø®ÙˆØ§Ù†Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ
          if [ -f "last_line.txt" ]; then
            LAST_LINE=$(cat last_line.txt 2>/dev/null | tr -d '\n' || echo 'Ù†Ø§Ù…Ø´Ø®Øµ')
            echo "ğŸ“ Ø¢Ø®Ø±ÛŒÙ† Ø®Ø· Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡: $LAST_LINE"
          fi
          
          # ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø®Ø·ÙˆØ·
          if [ -f "texts.txt" ]; then
            TOTAL_LINES=$(wc -l < texts.txt || echo "0")
            echo "ğŸ“„ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø®Ø·ÙˆØ·: $TOTAL_LINES"
          fi
          
          if [ "${{ steps.commit-changes.outputs.CHANGES }}" = "true" ]; then
            echo "ğŸ’¾ ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ${{ steps.commit-changes.outputs.COMMIT_HASH }}"
          else
            echo "ğŸ“­ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯"
          fi
          
          echo ""
          echo "âœ… Ø§Ø¬Ø±Ø§ÛŒ workflow Ú©Ø§Ù…Ù„ Ø´Ø¯"
