name: "ðŸ“¢ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³Øª ØªÙ„Ú¯Ø±Ø§Ù…"

on:
  # Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ù‡Ø± Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡
  schedule:
    - cron: "*/30 * * * *"
  
  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø² GitHub UI
  workflow_dispatch:
    inputs:
      reason:
        description: "Ø¯Ù„ÛŒÙ„ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ"
        required: false
        default: "ØªØ³Øª Ø¯Ø³ØªÛŒ"

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ÛŒØ· Ø§Ø¬Ø±Ø§
env:
  PYTHON_VERSION: "3.10"
  TZ: "Asia/Tehran"

jobs:
  send-telegram-post:
    name: "Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…"
    runs-on: ubuntu-latest-8core
    
    # Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù…
    permissions:
      contents: write
      actions: write
      checks: write
    
    # Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
    continue-on-error: false
    timeout-minutes: 5
    
    steps:
      # Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯
      - name: "ðŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ø±ÛŒÙ¾ÙˆØ²ÛŒØªÙˆØ±ÛŒ"
        id: checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true
      
      # Ù…Ø±Ø­Ù„Ù‡ Û²: ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§ÛŒØªÙˆÙ†
      - name: "ðŸ ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§ÛŒØªÙˆÙ† ${{ env.PYTHON_VERSION }}"
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '**/*requirements*.txt'
      
      # Ù…Ø±Ø­Ù„Ù‡ Û³: Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
      - name: "ðŸ“¦ Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²"
        id: install-deps
        run: |
          echo "ðŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§..."
          pip install --upgrade pip
          pip install requests==2.31.0
          pip install jdatetime==4.1.1
          pip cache purge
          echo "âœ… Ù†ØµØ¨ Ú©Ø§Ù…Ù„ Ø´Ø¯"
      
      # Ù…Ø±Ø­Ù„Ù‡ Û´: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
      - name: "ðŸ“Š Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…"
        id: system-check
        run: |
          echo "ðŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ..."
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ texts.txt
          if [ -f "texts.txt" ]; then
            LINE_COUNT=$(grep -c '[^[:space:]]' texts.txt || echo "0")
            echo "ðŸ“„ texts.txt: $LINE_COUNT Ø®Ø·"
          else
            echo "âŒ ÙØ§ÛŒÙ„ texts.txt ÛŒØ§ÙØª Ù†Ø´Ø¯!"
            exit 1
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ/Ø§ÛŒØ¬Ø§Ø¯ last_line.txt
          if [ ! -f "last_line.txt" ]; then
            echo "0" > last_line.txt
            echo "ðŸ“ last_line.txt Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ (Ù…Ù‚Ø¯Ø§Ø±: 0)"
          else
            CURRENT_LINE=$(cat last_line.txt | tr -d '\n' || echo "0")
            echo "ðŸ“ last_line.txt Ù…ÙˆØ¬ÙˆØ¯ (Ù…Ù‚Ø¯Ø§Ø±: $CURRENT_LINE)"
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ø³Ú©Ø±Øªâ€ŒÙ‡Ø§
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: TELEGRAM_BOT_TOKEN ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡"
          fi
          
          if [ -z "${{ secrets.TELEGRAM_CHANNEL_ID }}" ]; then
            echo "âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: TELEGRAM_CHANNEL_ID ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡"
          fi
          
          echo "âœ… Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯"
      
      # Ù…Ø±Ø­Ù„Ù‡ Ûµ: Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ø§ØµÙ„ÛŒ
      - name: "ðŸ¤– Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…"
        id: run-bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          RUN_REASON: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.reason || 'Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©' }}
        run: |
          echo "ðŸš€ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…"
          echo "ðŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¬Ø±Ø§:"
          echo "   â€¢ Run ID: $GITHUB_RUN_ID"
          echo "   â€¢ Run Number: $GITHUB_RUN_NUMBER"
          echo "   â€¢ Ø¯Ù„ÛŒÙ„ Ø§Ø¬Ø±Ø§: $RUN_REASON"
          echo "   â€¢ Ø²Ù…Ø§Ù† Ø³Ø±ÙˆØ±: $(date)"
          echo "   â€¢ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ: $TZ"
          echo ""
          
          # Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø§ÛŒØªÙˆÙ†
          python bot.py
          
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Ø±Ø¨Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯"
          else
            echo "âŒ Ø±Ø¨Ø§Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯ (Ú©Ø¯ Ø®Ø±ÙˆØ¬: $EXIT_CODE)"
            exit $EXIT_CODE
          fi
      
      # Ù…Ø±Ø­Ù„Ù‡ Û¶: Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
      - name: "ðŸ’¾ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØºÛŒÛŒØ±Ø§Øª"
        id: commit-changes
        if: always()
        run: |
          echo "ðŸ’¾ Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ..."
          
          # ØªÙ†Ø¸ÛŒÙ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡
          git add last_line.txt
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒØ§ ØªØºÛŒÛŒØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
          if git diff --cached --quiet; then
            echo "ðŸ“­ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ commit ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
            echo "CHANGES=false" >> $GITHUB_OUTPUT
          else
            # Ø§ÛŒØ¬Ø§Ø¯ commit
            COMMIT_MSG="ðŸ¤– Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± last_line.txt"
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              COMMIT_MSG="$COMMIT_MSG (Ø¯Ø³ØªÛŒ)"
            fi
            
            git commit -m "$COMMIT_MSG" -m "Run: ${{ github.run_id }} | Ø´Ù…Ø§Ø±Ù‡: ${{ github.run_number }}"
            
            # push ØªØºÛŒÛŒØ±Ø§Øª
            echo "ðŸ“¤ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª..."
            git push origin HEAD:${{ github.ref_name }}
            
            echo "âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯"
            echo "CHANGES=true" >> $GITHUB_OUTPUT
            echo "COMMIT_HASH=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          fi
      
      # Ù…Ø±Ø­Ù„Ù‡ Û·: Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
      - name: "ðŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø¬Ø±Ø§"
        if: always()
        run: |
          echo "=" * 60
          echo "ðŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø¬Ø±Ø§"
          echo "=" * 60
          echo ""
          echo "ðŸ ÙˆØ¶Ø¹ÛŒØª: ${{ job.status }}"
          echo "ðŸ†” Ø´Ù†Ø§Ø³Ù‡ Ø§Ø¬Ø±Ø§: ${{ github.run_id }}"
          echo "ðŸ”¢ Ø´Ù…Ø§Ø±Ù‡ Ø§Ø¬Ø±Ø§: ${{ github.run_number }}"
          echo "â° Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹: ${{ steps.run-bot.outputs.start_time }}"
          echo "ðŸ•’ Ù…Ø¯Øª Ø§Ø¬Ø±Ø§: ${{ steps.run-bot.outputs.duration }} Ø«Ø§Ù†ÛŒÙ‡"
          echo "ðŸ“ Ø¢Ø®Ø±ÛŒÙ† Ø®Ø· Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡: $(cat last_line.txt 2>/dev/null || echo 'Ù†Ø§Ù…Ø´Ø®Øµ')"
          
          if [ "${{ steps.commit-changes.outputs.CHANGES }}" = "true" ]; then
            echo "ðŸ’¾ ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ${{ steps.commit-changes.outputs.COMMIT_HASH }}"
          else
            echo "ðŸ“­ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯"
          fi
          
          echo ""
          echo "âœ… Ø§Ø¬Ø±Ø§ÛŒ workflow Ú©Ø§Ù…Ù„ Ø´Ø¯"
