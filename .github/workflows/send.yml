name: "30-Minute Telegram Bot"
on:
  # Ø¯Ùˆ trigger Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†
  schedule:
    - cron: "0,30 * * * *"  # Ø¯Ù‚ÛŒÙ‚Ù‡ 0 Ùˆ 30 Ù‡Ø± Ø³Ø§Ø¹Øª UTC
  
  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  workflow_dispatch:
    inputs:
      force:
        description: 'Force send even if no new lines'
        required: false
        default: 'false'

jobs:
  send:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Ø§ÛŒÙ† Ø®Ø· Ø­ÛŒØ§ØªÛŒ Ø§Ø³Øª
    
    steps:
      - name: ğŸ“… Calculate Iran time
        id: time
        run: |
          IRAN_TIME=$(TZ=Asia/Tehran date '+%H:%M')
          echo "iran_time=$IRAN_TIME" >> $GITHUB_OUTPUT
          echo "ğŸ“± Iran Time: $IRAN_TIME"
          echo "ğŸ• UTC Time: $(date -u)"
          
      - name: ğŸ”„ Checkout code with token
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Ø§ÛŒÙ† Ø®Ø· Ù…Ù‡Ù… Ø§Ø³Øª
          
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          
      - name: ğŸ“¦ Install dependencies
        run: pip install requests jdatetime
        
      - name: ğŸ¤– Run Telegram Bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        run: python bot.py
        
      - name: ğŸ’¾ Save progress
        if: success()
        run: |
          echo "ğŸ“Š Checking for changes..."
          git status
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add and check if there are changes
          git add last_line.txt
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ No changes to commit"
          else
            echo "ğŸ“ Committing changes..."
            git commit -m "â±ï¸ Auto-update at ${{ steps.time.outputs.iran_time }} IR"
            git push
            echo "âœ… Changes pushed successfully"
          fi
